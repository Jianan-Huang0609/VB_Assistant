<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>é¡¹ç›®è®°å½• Â· æŠ€æœ¯æ ˆçŸ©é˜µè§„åˆ’å™¨ Â· v3 (compact)</title>
  <base href="./">
  <style>
    :root{
      --oat:#EDE3E1; --sage:#C7BEBE; --charcoal:#655C5C; --ink:#2F2A2A; --paper:#FAF8F7;
      --ok:#2e7d32; --warn:#d97706; --muted:#8b8686;
      --radius:22px; --gap:14px; --shadow:0 10px 20px rgba(0,0,0,.06);

      /* å›ºå®šé…è‰²ï¼ˆä¸å†è‡ªåŠ¨åˆ‡æ¢ï¼‰ */
      --rowOdd:#FAFAFA;
      --rowEven:#FFFFFF;
      --headOdd:#EDE3E1;
      --headEven:#D6E5E9;
      --hover:#F0F8FF;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--paper);color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue','Noto Sans SC',Arial}
    .wrap{max-width:1400px;margin:24px auto;padding:0 16px}
    .title{font-size:26px;font-weight:800;display:flex;align-items:center;gap:10px}
    .card{background:white;border:1px solid var(--sage);border-radius:var(--radius);box-shadow:var(--shadow)}
    .row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:var(--gap)}
    .card.pad{padding:16px}
    .muted{color:var(--muted)}
    .pill{display:inline-flex;align-items:center;gap:8px;background:var(--oat);border:1px solid var(--sage);padding:6px 10px;border-radius:999px;font-size:12px}
    input[type=text], select, textarea, input[type=date]{width:100%;padding:10px 12px;border:1px solid var(--sage);border-radius:12px;background:#fff}
    textarea{min-height:88px;resize:vertical}

    /* çŸ©é˜µè¡¨æ ¼ */
    .matrix-wrap{margin-top:16px;overflow:auto}
    table.matrix{border-collapse:separate;border-spacing:0;min-width:1600px} /* æ›´å®½ */
    .matrix th,.matrix td{border:1px solid var(--sage);padding:10px;vertical-align:top;background:#fff}
    .matrix thead th{position:sticky;top:0;background:var(--oat);z-index:2}
    .matrix tbody th{position:sticky;left:0;background:var(--oat);z-index:1;min-width:180px} /* ç¬¬ä¸€åˆ—æ›´çª„ */
    .matrix td{min-width:240px} /* æ•°æ®åˆ—æ›´å®½ */
    .matrix td.disabled{background:#f5f5f5;color:#aaa;text-align:center}
    .cell-box{display:flex;flex-direction:column;gap:8px}
    .options{display:flex;flex-direction:column;gap:6px}
    .opt{display:flex;align-items:center;gap:8px}
    .opt input[type=checkbox]{width:16px;height:16px;accent-color:var(--charcoal)}
    .note-toggle{cursor:pointer;border:none;background:transparent;color:var(--charcoal);font-size:12px;text-decoration:underline;align-self:flex-start}
    .cell-note{display:none}
    .cell-note.show{display:block}

    /* è¡Œæ¡çº¹å›ºå®š + æ‚¬åœ */
    .matrix tbody tr:nth-child(odd) td{background:var(--rowOdd)}
    .matrix tbody tr:nth-child(even) td{background:var(--rowEven)}
    .matrix tbody tr:hover td{background:var(--hover)}
    /* è¡¨å¤´äº¤æ›¿è‰²å— */
    .matrix thead th:nth-child(odd){background:var(--headOdd)}
    .matrix thead th:nth-child(even){background:var(--headEven)}

    /* å¤‡æ³¨ä¸æ—¥å†ï¼šé«˜åº¦å¯¹é½ */
    .row-notes{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap);align-items:stretch}
    .h-260{min-height:260px}

    /* ToDo æ ·å¼ + ç´§å‡‘å·¥å…·æ  */
    .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .btn{border:1px solid var(--charcoal);background:var(--charcoal);color:#fff;padding:6px 10px;border-radius:10px;cursor:pointer;font-size:13px}
    .btn.ghost{background:#fff;color:var(--charcoal)}
    .btn.warn{background:var(--warn);border-color:var(--warn)}
    .btn.ok{background:var(--ok);border-color:var(--ok)}
    .small{font-size:12px}
    .todo-item{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border:1px solid var(--sage);border-radius:12px}
    .todo-item.done{opacity:.6;text-decoration:line-through}

    /* æ¦‚è§ˆæ¡ï¼ˆå•è¡Œæ¨ªå‘æ»šåŠ¨çš„å°å¡ç‰‡ï¼‰ */
    .summary-strip{display:flex;gap:10px;overflow:auto;padding:8px}
    .summary-card{min-width:230px;max-width:230px}
    .footer{margin:18px 0 40px;text-align:center;color:var(--muted)}

    /* æ¨¡æ€æ¡†æ ·å¼ */
    .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;display:flex;align-items:center;justify-content:center}
    .modal-content{background:white;border-radius:var(--radius);box-shadow:var(--shadow);max-width:500px;width:90%;max-height:80vh;overflow:hidden}
    .modal-header{display:flex;justify-content:space-between;align-items:center;padding:16px;border-bottom:1px solid var(--sage)}
    .modal-header h3{margin:0;font-size:18px}
    .modal-close{background:none;border:none;font-size:24px;cursor:pointer;color:var(--muted)}
    .modal-body{padding:16px}
    .modal-footer{display:flex;justify-content:flex-end;gap:10px;padding:16px;border-top:1px solid var(--sage)}
    .form-group{margin-bottom:16px}
    .form-group label{display:block;margin-bottom:6px;font-weight:500;color:var(--charcoal)}
    .form-group select,.form-group textarea{width:100%;padding:10px;border:1px solid var(--sage);border-radius:8px;font-size:14px}
    .form-group textarea{resize:vertical;min-height:80px}

    /* è®¤è¯çŠ¶æ€æç¤º */
    .auth-status {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 10px 15px;
      border-radius: 8px;
      font-size: 12px;
      z-index: 1000;
    }
    .auth-status.connected { background: rgba(46, 125, 50, 0.8); }
    .auth-status.disconnected { background: rgba(211, 119, 6, 0.8); }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">ğŸ“’ é¡¹ç›®è®°å½• Â· æŠ€æœ¯æ ˆçŸ©é˜µè§„åˆ’å™¨ <span class="pill muted">çºµè½´ï¼šæŠ€æœ¯é€‰æ‹©ï½œæ¨ªè½´ï¼šé˜¶æ®µ</span></div>

    <!-- è®¤è¯çŠ¶æ€æç¤º -->
    <div id="authStatus" class="auth-status disconnected">
      ğŸ”„ æ­£åœ¨æ£€æŸ¥è®¤è¯çŠ¶æ€...
    </div>

    <!-- é¡¶éƒ¨ä¿¡æ¯æ  -->
    <div class="card pad" style="margin-top:14px">
      <div class="row">
        <div>
          <label class="small muted">å¼€å‘é˜¶æ®µï¼ˆV1â€“V5ï¼‰</label>
          <select id="phaseStage">
            <option value="V1">V1</option>
            <option value="V2">V2</option>
            <option value="V3">V3</option>
            <option value="V4">V4</option>
            <option value="V5">V5</option>
          </select>
        </div>
        <div>
          <label class="small muted">é¡¹ç›®åç§°</label>
          <input type="text" id="projectName" placeholder="è¾“å…¥é¡¹ç›®åç§°" />
        </div>
        <div>
          <label class="small muted">é¡¹ç›®æè¿°</label>
          <input type="text" id="projectDescription" placeholder="ç®€è¦æè¿°é¡¹ç›®ç›®æ ‡" />
        </div>
      </div>
    </div>

    <!-- æŠ€æœ¯æ ˆçŸ©é˜µ -->
    <div class="card pad" style="margin-top:14px">
      <div class="toolbar">
        <div class="btn" onclick="saveToSupabase()">ğŸ’¾ ä¿å­˜åˆ°äº‘ç«¯</div>
        <div class="btn ghost" onclick="loadFromSupabase()">ğŸ“¥ ä»äº‘ç«¯åŠ è½½</div>
        <div class="btn ghost" onclick="exportData()">ğŸ“¤ å¯¼å‡ºæ•°æ®</div>
        <div class="btn ghost" onclick="showAddOptionModal()">â• æ·»åŠ æŠ€æœ¯é€‰é¡¹</div>
      </div>
      
      <div class="matrix-wrap">
        <table class="matrix" id="techMatrix">
          <!-- çŸ©é˜µå†…å®¹å°†é€šè¿‡ JavaScript åŠ¨æ€ç”Ÿæˆ -->
        </table>
      </div>
    </div>

    <!-- å¤‡æ³¨ä¸æ—¥å† -->
    <div class="row-notes" style="margin-top:14px">
      <div class="card pad h-260">
        <h4>ğŸ“ é¡¹ç›®å¤‡æ³¨</h4>
        <textarea id="globalNotes" placeholder="è®°å½•é¡¹ç›®ç›¸å…³çš„å¤‡æ³¨ä¿¡æ¯..."></textarea>
      </div>
      <div class="card pad h-260">
        <h4>ğŸ“… é‡è¦æ—¥æœŸ</h4>
        <div id="importantDates">
          <div style="margin-bottom:10px;">
            <label class="small muted">å¼€å§‹æ—¥æœŸ</label>
            <input type="date" id="startDate" />
          </div>
          <div style="margin-bottom:10px;">
            <label class="small muted">é¢„è®¡å®Œæˆ</label>
            <input type="date" id="endDate" />
          </div>
          <div style="margin-bottom:10px;">
            <label class="small muted">é‡Œç¨‹ç¢‘</label>
            <input type="text" id="milestone" placeholder="å…³é”®é‡Œç¨‹ç¢‘" />
          </div>
        </div>
      </div>
    </div>

    <!-- æ¦‚è§ˆæ¡ -->
    <div class="summary-strip" style="margin-top:14px">
      <div class="summary-card card pad">
        <h4>ğŸ“Š æŠ€æœ¯è¦†ç›–</h4>
        <div id="techCoverage">è®¡ç®—ä¸­...</div>
      </div>
      <div class="summary-card card pad">
        <h4>â±ï¸ æ—¶é—´è§„åˆ’</h4>
        <div id="timePlanning">è®¡ç®—ä¸­...</div>
      </div>
      <div class="summary-card card pad">
        <h4>ğŸ¯ å®Œæˆåº¦</h4>
        <div id="completionRate">è®¡ç®—ä¸­...</div>
      </div>
    </div>

    <!-- æ·»åŠ æŠ€æœ¯é€‰é¡¹æ¨¡æ€æ¡† -->
    <div id="addOptionModal" class="modal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h3>æ·»åŠ æŠ€æœ¯é€‰é¡¹</h3>
          <button class="modal-close" onclick="hideAddOptionModal()">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>æŠ€æœ¯ç±»åˆ«</label>
            <select id="categorySelect">
              <option value="">è¯·é€‰æ‹©æŠ€æœ¯ç±»åˆ«</option>
            </select>
          </div>
          <div class="form-group">
            <label>å¼€å‘é˜¶æ®µ</label>
            <select id="phaseSelect">
              <option value="">è¯·é€‰æ‹©é˜¶æ®µ</option>
            </select>
          </div>
          <div class="form-group">
            <label>æŠ€æœ¯é€‰é¡¹å†…å®¹</label>
            <textarea id="optionContent" placeholder="è¾“å…¥æŠ€æœ¯é€‰é¡¹çš„å…·ä½“å†…å®¹..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn ghost" onclick="hideAddOptionModal()">å–æ¶ˆ</button>
          <button class="btn" onclick="addNewOption()">æ·»åŠ </button>
        </div>
      </div>
    </div>

    <div class="footer">
      VB Assistant Â· æŠ€æœ¯æ ˆçŸ©é˜µè§„åˆ’å™¨ v3
    </div>
  </div>

  <!-- Supabase SDK -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  
  <script>
    // å…¨å±€å˜é‡
    let supabaseClient;
    let currentUser = null;
    let projectId = null;
    
    // é»˜è®¤çŠ¶æ€
    const defaultState = {
      projectName: '',
      projectDescription: '',
      phaseStage: 'V1',
      globalNotes: '',
      startDate: '',
      endDate: '',
      milestone: '',
      matrixData: {},
      lastUpdated: new Date().toISOString()
    };
    
    let state = JSON.parse(JSON.stringify(defaultState));

    // æŠ€æœ¯ç±»åˆ«å®šä¹‰
    const CATEGORIES = [
      {
        id: 'frontend',
        name: 'å‰ç«¯æŠ€æœ¯',
        phases: ['V1', 'V2', 'V3', 'V4', 'V5'],
        options_by_phase: {
          'V1': ['HTML5', 'CSS3', 'JavaScript'],
          'V2': ['React', 'Vue.js', 'Angular'],
          'V3': ['TypeScript', 'Sass/Less', 'Webpack'],
          'V4': ['PWA', 'SSR', 'å¾®å‰ç«¯'],
          'V5': ['WebAssembly', 'WebGL', 'AIé›†æˆ']
        }
      },
      {
        id: 'backend',
        name: 'åç«¯æŠ€æœ¯',
        phases: ['V1', 'V2', 'V3', 'V4', 'V5'],
        options_by_phase: {
          'V1': ['Node.js', 'Express', 'MongoDB'],
          'V2': ['Python', 'Django', 'PostgreSQL'],
          'V3': ['Java', 'Spring Boot', 'MySQL'],
          'V4': ['å¾®æœåŠ¡', 'Docker', 'Kubernetes'],
          'V5': ['GraphQL', 'gRPC', 'äº‹ä»¶é©±åŠ¨']
        }
      },
      {
        id: 'devops',
        name: 'DevOps',
        phases: ['V1', 'V2', 'V3', 'V4', 'V5'],
        options_by_phase: {
          'V1': ['Git', 'GitHub', 'åŸºç¡€CI/CD'],
          'V2': ['Docker', 'Jenkins', 'è‡ªåŠ¨åŒ–æµ‹è¯•'],
          'V3': ['Kubernetes', 'ç›‘æ§', 'æ—¥å¿—ç®¡ç†'],
          'V4': ['IaC', 'äº‘åŸç”Ÿ', 'å®‰å…¨æ‰«æ'],
          'V5': ['AIè¿ç»´', 'æ··æ²Œå·¥ç¨‹', 'SRE']
        }
      }
    ];

    const PHASES = ['V1', 'V2', 'V3', 'V4', 'V5'];

    // åˆå§‹åŒ– Supabase
    async function initSupabase() {
      try {
        supabaseClient = window.supabase.createClient(
          'https://ebbitzscqizogrfyfklh.supabase.co',
          'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImViYml0enNjcWl6b2dyZnlma2xoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0NDAzNTMsImV4cCI6MjA3MjAxNjM1M30.f0gSCCHJ_sEFV9R6IGOcr3CYnaVrZsnIxP3VDFP_RZM'
        );

        // æ£€æŸ¥è®¤è¯çŠ¶æ€
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (session) {
          currentUser = session.user;
          updateAuthStatus(true);
          await loadFromSupabase();
        } else {
          updateAuthStatus(false);
          loadFromLocalStorage();
        }

        // ç›‘å¬è®¤è¯çŠ¶æ€å˜åŒ–
        supabaseClient.auth.onAuthStateChange(async (event, session) => {
          if (event === 'SIGNED_IN') {
            currentUser = session.user;
            updateAuthStatus(true);
            await loadFromSupabase();
          } else if (event === 'SIGNED_OUT') {
            currentUser = null;
            updateAuthStatus(false);
            loadFromLocalStorage();
          }
        });

      } catch (error) {
        console.error('Supabase åˆå§‹åŒ–å¤±è´¥:', error);
        updateAuthStatus(false);
        loadFromLocalStorage();
      }
    }

    // æ›´æ–°è®¤è¯çŠ¶æ€æ˜¾ç¤º
    function updateAuthStatus(isConnected) {
      const authStatus = document.getElementById('authStatus');
      if (isConnected) {
        authStatus.textContent = `âœ… å·²è¿æ¥ (${currentUser?.email || 'ç”¨æˆ·'})`;
        authStatus.className = 'auth-status connected';
      } else {
        authStatus.textContent = 'âŒ æœªè¿æ¥ - æ•°æ®ä»…ä¿å­˜åˆ°æœ¬åœ°';
        authStatus.className = 'auth-status disconnected';
      }
    }

    // ä¿å­˜åˆ° Supabase
    async function saveToSupabase() {
      if (!currentUser) {
        alert('è¯·å…ˆç™»å½•ä»¥ä¿å­˜åˆ°äº‘ç«¯');
        return;
      }

      try {
        const projectData = {
          owner: currentUser.id,
          name: state.projectName || 'æœªå‘½åé¡¹ç›®',
          description: state.projectDescription,
          phase_stage: state.phaseStage,
          global_notes: state.globalNotes,
          start_date: state.startDate,
          end_date: state.endDate,
          milestone: state.milestone,
          matrix_data: state.matrixData,
          last_updated: new Date().toISOString()
        };

        let result;
        if (projectId) {
          // æ›´æ–°ç°æœ‰é¡¹ç›®
          result = await supabaseClient
            .from('poc_projects')
            .update(projectData)
            .eq('id', projectId)
            .eq('owner', currentUser.id)
            .select()
            .single();
        } else {
          // åˆ›å»ºæ–°é¡¹ç›®
          result = await supabaseClient
            .from('poc_projects')
            .insert(projectData)
            .select()
            .single();
          if (result.data) {
            projectId = result.data.id;
          }
        }

        if (result.error) throw result.error;
        
        alert('âœ… æ•°æ®å·²ä¿å­˜åˆ°äº‘ç«¯ï¼');
        console.log('ä¿å­˜æˆåŠŸ:', result.data);
      } catch (error) {
        console.error('ä¿å­˜å¤±è´¥:', error);
        alert('âŒ ä¿å­˜å¤±è´¥: ' + error.message);
      }
    }

    // ä» Supabase åŠ è½½
    async function loadFromSupabase() {
      if (!currentUser) {
        console.log('ç”¨æˆ·æœªç™»å½•ï¼Œæ— æ³•ä»äº‘ç«¯åŠ è½½');
        return;
      }

      try {
        // åŠ è½½æœ€æ–°çš„é¡¹ç›®æ•°æ®
        const { data, error } = await supabaseClient
          .from('poc_projects')
          .select('*')
          .eq('owner', currentUser.id)
          .order('last_updated', { ascending: false })
          .limit(1)
          .single();

        if (error && error.code !== 'PGRST116') { // PGRST116 è¡¨ç¤ºæ²¡æœ‰æ‰¾åˆ°æ•°æ®
          throw error;
        }

        if (data) {
          projectId = data.id;
          state = {
            projectName: data.name || '',
            projectDescription: data.description || '',
            phaseStage: data.phase_stage || 'V1',
            globalNotes: data.global_notes || '',
            startDate: data.start_date || '',
            endDate: data.end_date || '',
            milestone: data.milestone || '',
            matrixData: data.matrix_data || {},
            lastUpdated: data.last_updated || new Date().toISOString()
          };
          
          updateUI();
          console.log('ä»äº‘ç«¯åŠ è½½æˆåŠŸ:', data);
        } else {
          console.log('äº‘ç«¯æ²¡æœ‰æ‰¾åˆ°é¡¹ç›®æ•°æ®');
        }
      } catch (error) {
        console.error('ä»äº‘ç«¯åŠ è½½å¤±è´¥:', error);
        alert('âŒ ä»äº‘ç«¯åŠ è½½å¤±è´¥: ' + error.message);
      }
    }

    // ä»æœ¬åœ°å­˜å‚¨åŠ è½½ï¼ˆå¤‡ç”¨ï¼‰
    function loadFromLocalStorage() {
      try {
        const saved = localStorage.getItem('poc-tech-matrix-v3');
        if (saved) {
          state = JSON.parse(saved);
          updateUI();
          console.log('ä»æœ¬åœ°å­˜å‚¨åŠ è½½æˆåŠŸ');
        }
      } catch (error) {
        console.error('ä»æœ¬åœ°å­˜å‚¨åŠ è½½å¤±è´¥:', error);
      }
    }

    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆå¤‡ç”¨ï¼‰
    function saveToLocalStorage() {
      try {
        localStorage.setItem('poc-tech-matrix-v3', JSON.stringify(state));
      } catch (error) {
        console.error('ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨å¤±è´¥:', error);
      }
    }

    // æ›´æ–° UI
    function updateUI() {
      document.getElementById('projectName').value = state.projectName;
      document.getElementById('projectDescription').value = state.projectDescription;
      document.getElementById('phaseStage').value = state.phaseStage;
      document.getElementById('globalNotes').value = state.globalNotes;
      document.getElementById('startDate').value = state.startDate;
      document.getElementById('endDate').value = state.endDate;
      document.getElementById('milestone').value = state.milestone;
      
      renderMatrix();
      renderSummaryStrip();
    }

    // æ¸²æŸ“æŠ€æœ¯æ ˆçŸ©é˜µ
    function renderMatrix() {
      const table = document.getElementById('techMatrix');
      
      // åˆ›å»ºè¡¨å¤´
      let headerRow = '<thead><tr><th>æŠ€æœ¯ç±»åˆ«</th>';
      PHASES.forEach(phase => {
        headerRow += `<th>${phase}</th>`;
      });
      headerRow += '</tr></thead>';
      
      // åˆ›å»ºè¡¨ä½“
      let bodyRows = '<tbody>';
      CATEGORIES.forEach(category => {
        bodyRows += '<tr>';
        bodyRows += `<th>${category.name}</th>`;
        
        PHASES.forEach(phase => {
          const key = keyOf(category.id, phase);
          const cellData = state.matrixData[key] || { selected: [], notes: '' };
          
          bodyRows += '<td>';
          bodyRows += '<div class="cell-box">';
          
          // æŠ€æœ¯é€‰é¡¹
          if (category.options_by_phase && category.options_by_phase[phase]) {
            category.options_by_phase[phase].forEach(option => {
              const isSelected = cellData.selected.includes(option);
              bodyRows += `
                <div class="opt">
                  <input type="checkbox" 
                         ${isSelected ? 'checked' : ''} 
                         onchange="toggleOption('${category.id}', '${phase}', '${escapeHtml(option)}', this.checked)" />
                  <span>${escapeHtml(option)}</span>
                </div>
              `;
            });
          }
          
          // å¤‡æ³¨
          if (cellData.notes) {
            bodyRows += `
              <button class="note-toggle" onclick="toggleNote('${category.id}', '${phase}')">ğŸ“ æŸ¥çœ‹å¤‡æ³¨</button>
              <div class="cell-note" id="note-${category.id}-${phase}">${escapeHtml(cellData.notes)}</div>
            `;
          }
          
          bodyRows += '</div></td>';
        });
        
        bodyRows += '</tr>';
      });
      bodyRows += '</tbody>';
      
      table.innerHTML = headerRow + bodyRows;
    }

    // æ¸²æŸ“æ¦‚è§ˆæ¡
    function renderSummaryStrip() {
      // è®¡ç®—æŠ€æœ¯è¦†ç›–
      let totalOptions = 0;
      let selectedOptions = 0;
      
      CATEGORIES.forEach(category => {
        PHASES.forEach(phase => {
          if (category.options_by_phase && category.options_by_phase[phase]) {
            totalOptions += category.options_by_phase[phase].length;
            const key = keyOf(category.id, phase);
            const cellData = state.matrixData[key] || { selected: [] };
            selectedOptions += cellData.selected.length;
          }
        });
      });
      
      const coverageRate = totalOptions > 0 ? Math.round((selectedOptions / totalOptions) * 100) : 0;
      
      document.getElementById('techCoverage').innerHTML = `
        <div>å·²é€‰æ‹©: ${selectedOptions}/${totalOptions}</div>
        <div>è¦†ç›–ç‡: ${coverageRate}%</div>
      `;
      
      // æ—¶é—´è§„åˆ’
      const startDate = state.startDate ? new Date(state.startDate) : null;
      const endDate = state.endDate ? new Date(state.endDate) : null;
      
      let timeInfo = 'æœªè®¾ç½®æ—¶é—´';
      if (startDate && endDate) {
        const days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
        timeInfo = `${days} å¤©`;
      } else if (startDate) {
        timeInfo = 'å·²è®¾ç½®å¼€å§‹æ—¶é—´';
      }
      
      document.getElementById('timePlanning').innerHTML = `
        <div>${timeInfo}</div>
        <div>é˜¶æ®µ: ${state.phaseStage}</div>
      `;
      
      // å®Œæˆåº¦ï¼ˆåŸºäºå½“å‰é˜¶æ®µï¼‰
      const currentPhaseIndex = PHASES.indexOf(state.phaseStage);
      const completionRate = currentPhaseIndex >= 0 ? Math.round(((currentPhaseIndex + 1) / PHASES.length) * 100) : 0;
      
      document.getElementById('completionRate').innerHTML = `
        <div>å½“å‰é˜¶æ®µ: ${state.phaseStage}</div>
        <div>å®Œæˆåº¦: ${completionRate}%</div>
      `;
    }

    // åˆ‡æ¢æŠ€æœ¯é€‰é¡¹
    function toggleOption(categoryId, phase, option, isSelected) {
      const key = keyOf(categoryId, phase);
      if (!state.matrixData[key]) {
        state.matrixData[key] = { selected: [], notes: '' };
      }
      
      if (isSelected) {
        if (!state.matrixData[key].selected.includes(option)) {
          state.matrixData[key].selected.push(option);
        }
      } else {
        state.matrixData[key].selected = state.matrixData[key].selected.filter(item => item !== option);
      }
      
      state.lastUpdated = new Date().toISOString();
      saveToLocalStorage(); // æœ¬åœ°å¤‡ä»½
      
      if (currentUser) {
        saveToSupabase(); // è‡ªåŠ¨ä¿å­˜åˆ°äº‘ç«¯
      }
    }

    // åˆ‡æ¢å¤‡æ³¨æ˜¾ç¤º
    function toggleNote(categoryId, phase) {
      const noteElement = document.getElementById(`note-${categoryId}-${phase}`);
      noteElement.classList.toggle('show');
    }

    // å¯¼å‡ºæ•°æ®
    function exportData() {
      const dataStr = JSON.stringify(state, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `poc-tech-matrix-${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      URL.revokeObjectURL(url);
    }

    // æ·»åŠ æŠ€æœ¯é€‰é¡¹ç›¸å…³å‡½æ•°
    function showAddOptionModal() {
      const modal = document.getElementById('addOptionModal');
      const categorySelect = document.getElementById('categorySelect');
      const phaseSelect = document.getElementById('phaseSelect');
      
      // å¡«å……æŠ€æœ¯ç±»åˆ«é€‰é¡¹
      categorySelect.innerHTML = '<option value="">è¯·é€‰æ‹©æŠ€æœ¯ç±»åˆ«</option>';
      CATEGORIES.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.id;
        option.textContent = cat.name;
        categorySelect.appendChild(option);
      });
      
      // å¡«å……é˜¶æ®µé€‰é¡¹
      phaseSelect.innerHTML = '<option value="">è¯·é€‰æ‹©é˜¶æ®µ</option>';
      PHASES.forEach(phase => {
        const option = document.createElement('option');
        option.value = phase;
        option.textContent = phase;
        phaseSelect.appendChild(option);
      });
      
      modal.style.display = 'flex';
    }

    function hideAddOptionModal() {
      const modal = document.getElementById('addOptionModal');
      modal.style.display = 'none';
      // æ¸…ç©ºè¡¨å•
      document.getElementById('categorySelect').value = '';
      document.getElementById('phaseSelect').value = '';
      document.getElementById('optionContent').value = '';
    }

    function addNewOption() {
      const categoryId = document.getElementById('categorySelect').value;
      const phase = document.getElementById('phaseSelect').value;
      const content = document.getElementById('optionContent').value.trim();
      
      if (!categoryId || !phase || !content) {
        alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
        return;
      }
      
      // æ‰¾åˆ°å¯¹åº”çš„æŠ€æœ¯ç±»åˆ«
      const category = CATEGORIES.find(cat => cat.id === categoryId);
      if (!category) {
        alert('æŠ€æœ¯ç±»åˆ«ä¸å­˜åœ¨');
        return;
      }
      
      // æ·»åŠ æ–°çš„æŠ€æœ¯é€‰é¡¹
      if (category.options_by_phase && category.options_by_phase[phase]) {
        category.options_by_phase[phase].push(content);
      } else if (category.options_by_phase) {
        category.options_by_phase[phase] = [content];
      } else {
        alert('è¯¥æŠ€æœ¯ç±»åˆ«ä¸æ”¯æŒæ­¤é˜¶æ®µ');
        return;
      }
      
      // é‡æ–°æ¸²æŸ“çŸ©é˜µ
      renderMatrix();
      hideAddOptionModal();
      alert('æŠ€æœ¯é€‰é¡¹æ·»åŠ æˆåŠŸï¼');
    }

    // å·¥å…·å‡½æ•°
    function keyOf(catId, phase) { return `${catId}|${phase}`; }
    function escapeHtml(s) { return (s||'').replace(/[&<>\"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\'':'&#39;' }[m])); }

    // ç›‘å¬è¾“å…¥å˜åŒ–
    document.getElementById('projectName').addEventListener('input', function() {
      state.projectName = this.value;
      state.lastUpdated = new Date().toISOString();
      saveToLocalStorage();
      if (currentUser) saveToSupabase();
    });

    document.getElementById('projectDescription').addEventListener('input', function() {
      state.projectDescription = this.value;
      state.lastUpdated = new Date().toISOString();
      saveToLocalStorage();
      if (currentUser) saveToSupabase();
    });

    document.getElementById('phaseStage').addEventListener('change', function() {
      state.phaseStage = this.value;
      state.lastUpdated = new Date().toISOString();
      saveToLocalStorage();
      if (currentUser) saveToSupabase();
      renderSummaryStrip();
    });

    document.getElementById('globalNotes').addEventListener('input', function() {
      state.globalNotes = this.value;
      state.lastUpdated = new Date().toISOString();
      saveToLocalStorage();
      if (currentUser) saveToSupabase();
    });

    document.getElementById('startDate').addEventListener('change', function() {
      state.startDate = this.value;
      state.lastUpdated = new Date().toISOString();
      saveToLocalStorage();
      if (currentUser) saveToSupabase();
      renderSummaryStrip();
    });

    document.getElementById('endDate').addEventListener('change', function() {
      state.endDate = this.value;
      state.lastUpdated = new Date().toISOString();
      saveToLocalStorage();
      if (currentUser) saveToSupabase();
      renderSummaryStrip();
    });

    document.getElementById('milestone').addEventListener('input', function() {
      state.milestone = this.value;
      state.lastUpdated = new Date().toISOString();
      saveToLocalStorage();
      if (currentUser) saveToSupabase();
    });

    // åˆå§‹åŒ–
    initSupabase();
  </script>
</body>
</html>
