<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>é¡¹ç›®è®°å½• Â· æŠ€æœ¯æ ˆçŸ©é˜µè§„åˆ’å™¨ Â· v3 (compact)</title>
  <base href="./">
  <style>
    :root{
      --oat:#EDE3E1; --sage:#C7BEBE; --charcoal:#655C5C; --ink:#2F2A2A; --paper:#FAF8F7;
      --ok:#2e7d32; --warn:#d97706; --muted:#8b8686;
      --radius:22px; --gap:14px; --shadow:0 10px 20px rgba(0,0,0,.06);

      /* å›ºå®šé…è‰²ï¼ˆä¸å†è‡ªåŠ¨åˆ‡æ¢ï¼‰ */
      --rowOdd:#FAFAFA;
      --rowEven:#FFFFFF;
      --headOdd:#EDE3E1;
      --headEven:#D6E5E9;
      --hover:#F0F8FF;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--paper);color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue','Noto Sans SC',Arial}
    .wrap{max-width:1400px;margin:24px auto;padding:0 16px}
    .title{font-size:26px;font-weight:800;display:flex;align-items:center;gap:10px}
    .card{background:white;border:1px solid var(--sage);border-radius:var(--radius);box-shadow:var(--shadow)}
    .row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:var(--gap)}
    .card.pad{padding:16px}
    .muted{color:var(--muted)}
    .pill{display:inline-flex;align-items:center;gap:8px;background:var(--oat);border:1px solid var(--sage);padding:6px 10px;border-radius:999px;font-size:12px}
    input[type=text], select, textarea, input[type=date]{width:100%;padding:10px 12px;border:1px solid var(--sage);border-radius:12px;background:#fff}
    textarea{min-height:88px;resize:vertical}

    /* çŸ©é˜µè¡¨æ ¼ */
    .matrix-wrap{margin-top:16px;overflow:auto}
    table.matrix{border-collapse:separate;border-spacing:0;min-width:1600px} /* æ›´å®½ */
    .matrix th,.matrix td{border:1px solid var(--sage);padding:10px;vertical-align:top;background:#fff}
    .matrix thead th{position:sticky;top:0;background:var(--oat);z-index:2}
    .matrix tbody th{position:sticky;left:0;background:var(--oat);z-index:1;min-width:180px} /* ç¬¬ä¸€åˆ—æ›´çª„ */
    .matrix td{min-width:240px} /* æ•°æ®åˆ—æ›´å®½ */
    .matrix td.disabled{background:#f5f5f5;color:#aaa;text-align:center}
    .cell-box{display:flex;flex-direction:column;gap:8px}
    .options{display:flex;flex-direction:column;gap:6px}
    .opt{display:flex;align-items:center;gap:8px}
    .opt input[type=checkbox]{width:16px;height:16px;accent-color:var(--charcoal)}
    .note-toggle{cursor:pointer;border:none;background:transparent;color:var(--charcoal);font-size:12px;text-decoration:underline;align-self:flex-start}
    .cell-note{display:none}
    .cell-note.show{display:block}

    /* è¡Œæ¡çº¹å›ºå®š + æ‚¬åœ */
    .matrix tbody tr:nth-child(odd) td{background:var(--rowOdd)}
    .matrix tbody tr:nth-child(even) td{background:var(--rowEven)}
    .matrix tbody tr:hover td{background:var(--hover)}
    /* è¡¨å¤´äº¤æ›¿è‰²å— */
    .matrix thead th:nth-child(odd){background:var(--headOdd)}
    .matrix thead th:nth-child(even){background:var(--headEven)}

    /* å¤‡æ³¨ä¸æ—¥å†ï¼šé«˜åº¦å¯¹é½ */
    .row-notes{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap);align-items:stretch}
    .h-260{min-height:260px}

    /* ToDo æ ·å¼ + ç´§å‡‘å·¥å…·æ  */
    .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .btn{border:1px solid var(--charcoal);background:var(--charcoal);color:#fff;padding:6px 10px;border-radius:10px;cursor:pointer;font-size:13px}
    .btn.ghost{background:#fff;color:var(--charcoal)}
    .btn.warn{background:var(--warn);border-color:var(--warn)}
    .btn.ok{background:var(--ok);border-color:var(--ok)}
    .small{font-size:12px}
    .todo-item{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border:1px solid var(--sage);border-radius:12px}
    .todo-item.done{opacity:.6;text-decoration:line-through}

    /* æ¦‚è§ˆæ¡ï¼ˆå•è¡Œæ¨ªå‘æ»šåŠ¨çš„å°å¡ç‰‡ï¼‰ */
    .summary-strip{display:flex;gap:10px;overflow:auto;padding:8px}
    .summary-card{min-width:230px;max-width:230px}
    .footer{margin:18px 0 40px;text-align:center;color:var(--muted)}

    /* æ¨¡æ€æ¡†æ ·å¼ */
    .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;display:flex;align-items:center;justify-content:center}
    .modal-content{background:white;border-radius:var(--radius);box-shadow:var(--shadow);max-width:500px;width:90%;max-height:80vh;overflow:hidden}
    .modal-header{display:flex;justify-content:space-between;align-items:center;padding:16px;border-bottom:1px solid var(--sage)}
    .modal-header h3{margin:0;font-size:18px}
    .modal-close{background:none;border:none;font-size:24px;cursor:pointer;color:var(--muted)}
    .modal-body{padding:16px}
    .modal-footer{display:flex;justify-content:flex-end;gap:10px;padding:16px;border-top:1px solid var(--sage)}
    .form-group{margin-bottom:16px}
    .form-group label{display:block;margin-bottom:6px;font-weight:500;color:var(--charcoal)}
    .form-group select,.form-group textarea{width:100%;padding:10px;border:1px solid var(--sage);border-radius:8px;font-size:14px}
    .form-group textarea{resize:vertical;min-height:80px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">ğŸ“’ é¡¹ç›®è®°å½• Â· æŠ€æœ¯æ ˆçŸ©é˜µè§„åˆ’å™¨ <span class="pill muted">çºµè½´ï¼šæŠ€æœ¯é€‰æ‹©ï½œæ¨ªè½´ï¼šé˜¶æ®µ</span></div>

    <!-- é¡¶éƒ¨ä¿¡æ¯æ  -->
    <div class="card pad" style="margin-top:14px">
      <div class="row">
        <div>
          <label class="small muted">å¼€å‘é˜¶æ®µï¼ˆV1â€“V5ï¼‰</label>
          <select id="phaseStage">
            <option value="V1">V1</option>
            <option value="V2">V2</option>
            <option value="V3">V3</option>
            <option value="V4">V4</option>
            <option value="V5">V5</option>
          </select>
        </div>
        <div>
          <label class="small muted">å­ç‰ˆæœ¬å·</label>
          <input type="text" id="subVersion" placeholder="ä¾‹å¦‚ï¼š2025.08.21-a" />
        </div>
        <div style="display:flex;align-items:flex-end;gap:8px">
          <button class="btn ok" id="confirmMeta">ç¡®è®¤</button>
          <button class="btn ghost" id="editMeta" style="display:none">ä¿®æ”¹</button>
          <span class="small muted" id="metaStatus"></span>
        </div>
      </div>
    </div>

    <!-- çŸ©é˜µï¼ˆçºµè½´Ã—æ¨ªè½´ï¼‰ -->
    <div class="card pad" style="margin-top:14px">
      <div class="toolbar" style="margin-bottom:10px">
        <button class="btn ok" id="saveBtn">ä¿å­˜ï¼ˆæœ¬åœ°ï¼‰</button>
        <button class="btn ghost" id="exportBtn">å¯¼å‡º JSON</button>
        <label class="btn ghost" for="importFile">å¯¼å…¥ JSON</label>
        <input id="importFile" type="file" accept="application/json" style="display:none" />
        <button class="btn warn" id="resetBtn">é‡ç½®</button>
        <div style="margin-left:auto">
          <button class="btn ok" id="addOptionBtn">â• æ–°å¢æŠ€æœ¯é€‰é¡¹</button>
        </div>
      </div>
      <div class="matrix-wrap">
        <table class="matrix" id="matrix"></table>
      </div>
    </div>

    <!-- å¤‡æ³¨ + Calendar ToDo å¯¹é½åŒºå— -->
    <div class="row-notes" style="margin-top:14px">
      <div class="card pad h-260" style="display:flex;flex-direction:column">
        <div class="small muted">å¤‡æ³¨æ ï¼ˆæ€»ä½“æƒ³æ³•ã€æµ‹è¯•ç»“æœã€æ”¹è¿›æ–¹å‘ï¼‰</div>
        <textarea id="globalNotes" style="flex:1" placeholder="ç¤ºä¾‹ï¼šESï¼ˆBM25ï¼‰+ FAISS çš„æ··åˆæ£€ç´¢ä¼˜äºå•å‘é‡ï¼›ä¸‹ä¸€æ­¥æŒ‰ RGB/RAGTruth è¯„æµ‹é›†åšå›å½’â€¦â€¦"></textarea>
      </div>
      <div class="card pad h-260" style="display:flex;flex-direction:column">
        <div class="small muted">Calendar ToDo</div>
        <div class="row" style="grid-template-columns:1fr 2fr auto;gap:10px">
          <div><input type="date" id="todoDate" /></div>
          <div><input type="text" id="todoText" placeholder="å¾…åŠäº‹é¡¹ï¼Œå¦‚ï¼šæŠ½æ ·å¤æ ¸å¬å› Top-K è´¨é‡" /></div>
          <div><button class="btn" id="addTodo">æ·»åŠ </button></div>
        </div>
        <div id="todoList" style="margin-top:12px;display:flex;flex-direction:column;gap:8px;overflow:auto"></div>
      </div>
    </div>

    <!-- ç´§å‡‘æ¦‚è§ˆï¼ˆå•è¡Œæ¨ªå‘æ»šåŠ¨ï¼‰ -->
    <div class="card pad" style="margin-top:14px">
      <div class="small muted">æ¦‚è§ˆ</div>
      <div id="summaryStrip" class="summary-strip"></div>
    </div>

    <div class="footer">@ Jianan Â· åŒ»æ¢° RA åœˆ Â· æœ€æ‡‚AI Â· çˆ±æ¸¸æ³³çš„è¾©è®ºé€‰æ‰‹</div>
  </div>

  <!-- æ–°å¢æŠ€æœ¯é€‰é¡¹æ¨¡æ€æ¡† -->
  <div id="addOptionModal" class="modal" style="display:none">
    <div class="modal-content">
      <div class="modal-header">
        <h3>æ–°å¢æŠ€æœ¯é€‰é¡¹</h3>
        <button class="modal-close" id="closeModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>é€‰æ‹©æŠ€æœ¯ç±»åˆ«ï¼š</label>
          <select id="categorySelect">
            <option value="">è¯·é€‰æ‹©æŠ€æœ¯ç±»åˆ«</option>
          </select>
        </div>
        <div class="form-group">
          <label>é€‰æ‹©é˜¶æ®µï¼š</label>
          <select id="phaseSelect">
            <option value="">è¯·é€‰æ‹©é˜¶æ®µ</option>
          </select>
        </div>
        <div class="form-group">
          <label>æŠ€æœ¯é€‰é¡¹å†…å®¹ï¼š</label>
          <textarea id="optionContent" placeholder="è¯·è¾“å…¥æŠ€æœ¯é€‰é¡¹çš„è¯¦ç»†æè¿°..." rows="4"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn ghost" id="cancelAdd">å–æ¶ˆ</button>
        <button class="btn ok" id="confirmAdd">ç¡®è®¤æ·»åŠ </button>
      </div>
    </div>
  </div>
  <script>
    // â€”â€” é˜¶æ®µï¼ˆæ¨ªè½´ï¼‰ â€”â€”
    const PHASES = [
      'æ–‡æ¡£é‡‡é›†/è§£æ',
      'æ¸…æ´—/å½’ä¸€åŒ–',
      'åˆ‡å—',
      'å‘é‡åŒ–/ç´¢å¼•',
      'æ£€ç´¢ï¼ˆæ··åˆå¬å›ï¼‰',
      'é‡æ’',
      'ç”Ÿæˆï¼ˆReasoningï¼‰',
      'å®¡æ ¸/åå¤„ç†',
      'è¯„æµ‹/ç›‘æ§',
      'éƒ¨ç½²/å®‰å…¨'
    ];

    // â€”â€” æŠ€æœ¯æ ç›®ï¼ˆçºµè½´ï¼‰ â€”â€”
    const CATEGORIES = [
      {
        id:'dp',
        name:'æ•°æ®å¤„ç† (Data Processing)',
        options:[],
        options_by_phase:{
          'æ–‡æ¡£é‡‡é›†/è§£æ':[
            'ç®€å•æ–‡æ¡£åŠ è½½ (Word-txt)',
            'å¤šæ ¼å¼è§£æ (Word, PDF, å›¾è¡¨)',
            'å¤šæºæ•°æ®æ¥å…¥ (æ³¨å†ŒåŒ… + é¡¹ç›®åŒ…)'
          ],
          'æ¸…æ´—/å½’ä¸€åŒ–':[
            'å¤æ‚è·¨åŸŸæ•°æ®æ¸…æ´—',
            'é«˜è´¨é‡ Instructionâ€“Answer æ•°æ®å¢å¼º',
            'é«˜è´¨é‡æ•°æ®å¯¹ (RA+R&D)'
          ],
          'åˆ‡å—':[
            'ç« èŠ‚/è¯­ä¹‰åˆ‡å— + å…ƒæ•°æ®æŠ½å–'
          ]
        }
      },
      {
        id:'kb',
        name:'çŸ¥è¯†åº“æ­å»º (Knowledge Base Setup)',
        options:[
          'å•ä¸€æ¥æºï¼šInput ç¤ºä¾‹ + å®˜æ–¹æ–‡æ¡£',
          'Embedding API',
          'æœ¬åœ°å‘é‡åº“- (FAISS/Chroma)/æ‰˜ç®¡å‘é‡åº“ï¼Ÿ',
          'å¤šæºç´¢å¼• + è·¯å¾„åŒ– RAG æ„å»º æ”¯æŒè·¨åŒ…/è·¨åŸŸæ•°æ®æµ',
          'å¤šæº RAG çŸ¥è¯†åº“',
          'RGB / RAGTruth æµ‹è¯•é›†ï¼ˆéªŒè¯åŸºå‡†ï¼‰',
          'é•¿æœŸè®°å¿†å‹å‘é‡åº“',
          'åŠ¨æ€æ›´æ–°åŸºå‡†æµ‹è¯•é›†ï¼ˆRGB/RAGTruthè¿­ä»£ï¼‰'
        ],
        phases:['å‘é‡åŒ–/ç´¢å¼•']
      },
      {
        id:'retr',
        name:'æ£€ç´¢ (Retrieval)',
        options:[
          'åŸºäº Prompt çš„å…³é”®è¯æ£€ç´¢\\nç®€å•å¤šè½®æ£€ç´¢',
          'BM25ï¼ˆå…³é”®è¯ï¼‰ï¼šElasticsearch/Lucene å†…ç½®ã€‚\\n\\nå‘é‡æ£€ç´¢ï¼ˆè¯­ä¹‰ï¼‰ï¼šFAISS/Pineconeã€‚ \\n\\n æ··åˆæ£€ç´¢ï¼šæŠŠä¸¤ç±»åˆ†æ•°åŠ æƒï¼Œå–ç»¼åˆ Top-Kã€‚',
          'åŠ¨æ€ RAG æ£€ç´¢é“¾\\n\\næ•°æ®å¯¹é©±åŠ¨å¬å›',
          'ç»“æ„åŒ–æ£€ç´¢é“¾ (Multi-Hop)\\n+ Hybrid RAG',
          'é•¿ä¸Šä¸‹æ–‡æ£€ç´¢\\n\\nåŠ¨æ€è·¯ç”±é€‰æ‹©'
        ],
        phases:['æ£€ç´¢ï¼ˆæ··åˆå¬å›ï¼‰']
      },
      {
        id:'re_rank',
        name:'é‡æ’ (Re-ranking)',
        options:[
          'è§„åˆ™åŒ¹é…',
          'Bi-Encoder / Cross-Encoder / ReRank æ¨¡å‹',
          'ReRank ä¼˜åŒ–ï¼›å¯è§‚æµ‹æ€§æ—¥å¿—',
          'å¯æ’æ‹” ReRank',
          'è‡ªé€‚åº”é‡æ’'
        ],
        phases:['é‡æ’']
      },
      {
        id:'gen2',
        name:'ç”Ÿæˆ (Generation)ï¼ˆè„šæœ¬/å°æ¨¡å‹/æ™ºèƒ½ä½“-LangGraphï¼‰',
        options:[
          'API è°ƒç”¨ï¼›åˆ†æ¨¡å— Prompt',
          'ç²¾ç»†åŒ– Prompt é“¾ï¼›å¯¹è¯å†å²ç®¡ç†',
          'åˆ†é“¾è·¯è„šæœ¬ + å°æ¨¡å‹ï¼›äººå·¥è¯„åˆ¤æ ‡å‡†ï¼›æ¨¡æ‹Ÿè¯„ä¼° API',
          'å°æ¨¡å‹å¾®è°ƒï¼›åˆ†é“¾è·¯è„šæœ¬åä½œ',
          'å¤šæ™ºèƒ½ä½“åä½œï¼›LangGraph/TaskGraph'
        ],
        phases:['ç”Ÿæˆï¼ˆReasoningï¼‰']
      },
      { id:'post', name:'åå¤„ç†/å¼•ç”¨', options:['é€æ¡å¼•ç”¨ï¼ˆæ–‡æ¡£/ç« èŠ‚/é¡µç ï¼‰','python-docx å¥—ç‰ˆ','Guardrailsï¼ˆç©ºç­”/ä½ç½®ä¿¡æç¤ºï¼‰','è¯æ®é«˜äº®ä¸è·³è½¬'], phases:['å®¡æ ¸/åå¤„ç†'] },
      { id:'eval', name:'è¯„æµ‹æŒ‡æ ‡', options:['Recall@k','MRR/nDCG','é¦–å±å¯ç”¨ç‡','å¼•ç”¨å®Œæ•´ç‡','äººå·¥æŠ½æ£€é¢æ¿'], phases:['è¯„æµ‹/ç›‘æ§'] },
      { id:'obs', name:'ç›‘æ§ä¸æ—¥å¿—', options:['Prometheus/Grafana','OpenTelemetry é“¾è·¯','å¤±è´¥é‡è¯•/å¹‚ç­‰å“ˆå¸Œ','å‘¨æŠ¥è‡ªåŠ¨åŒ–'], phases:['è¯„æµ‹/ç›‘æ§'] },
      { id:'deploy', name:'éƒ¨ç½²æ–¹å¼', options:['FastAPI æœåŠ¡åŒ–','Celery/RQ å¼‚æ­¥ç´¢å¼•','HPA/è¯»å†™åˆ†ç¦»','è®¿é—®æ§åˆ¶ä¸è„±æ•æ—¥å¿—','ç§æœ‰åŒ–/å†…ç½‘åŒ–'], phases:['éƒ¨ç½²/å®‰å…¨'] },
    ];

    // â€”â€” çŠ¶æ€ â€”â€”
    const defaultState = {
      meta:{stage:'V1', subVersion:'', confirmed:false},
      selections:{},
      notes:{},
      globalNotes:'',
      todos:[]
    };
    let state = loadState();

    // â€”â€” æ¸²æŸ“ â€”â€”
    function matrixHeadRow(){
      const badge = `<div class="small muted" id="stageBadge">é˜¶æ®µï¼š${state.meta.stage||''}  å­ç‰ˆæœ¬ï¼š${state.meta.subVersion||''}</div>`;
      return `<thead><tr><th style="min-width:180px">æŠ€æœ¯é€‰æ‹©\\è¿›ç¨‹${badge}</th>${PHASES.map(p=>`<th>${p}</th>`).join('')}</tr></thead>`;
    }

    function renderMatrix(){
      const table = document.getElementById('matrix');
      const thead = matrixHeadRow();

      const tbodyRows = CATEGORIES.map(cat=>{
        const cells = PHASES.map(phase=>{
          const explicitlyLimited = Array.isArray(cat.phases);
          let allowed = true;
          if(explicitlyLimited){
            allowed = cat.phases.includes(phase);
          }else if(cat.options_by_phase){
            allowed = Array.isArray(cat.options_by_phase[phase]);
          }else{
            allowed = false;
          }
          if(!allowed){ return `<td class="disabled">â€”</td>`; }

          const optionList = (cat.options_by_phase && cat.options_by_phase[phase]) ? cat.options_by_phase[phase] : (cat.options || []);
          const key = keyOf(cat.id, phase);
          const chosen = state.selections[key] || [];
          const note = state.notes[key] || '';
          const options = optionList.map(o=>{
            const checked = chosen.includes(o) ? 'checked' : '';
            return `<label class="opt"><input type="checkbox" data-key="${key}" data-val="${escapeHtml(o)}" ${checked}/> ${escapeHtml(o).replace(/\\n/g,'<br/>')}</label>`
          }).join('');
          return `<td>
            <div class="cell-box">
              <div class="options">${options || '<div class="muted small">ï¼ˆæ­¤åˆ—æš‚æ— å¯é€‰é¡¹ï¼‰</div>'}</div>
              <button class="note-toggle" data-key="${key}">ğŸ“ å¤‡æ³¨</button>
              <textarea class="cell-note ${note? 'show':''}" data-key="${key}" placeholder="è®°å½•è¯¥ç¯èŠ‚çš„æµ‹è¯•ç»“æœæˆ–æ”¹è¿›æ–¹å‘â€¦â€¦">${escapeHtml(note)}</textarea>
            </div>
          </td>`;
        }).join('');
        return `<tr><th>${cat.name}</th>${cells}</tr>`;
      }).join('');

      table.innerHTML = thead + `<tbody>${tbodyRows}</tbody>`;

      // äº‹ä»¶ç»‘å®š
      table.querySelectorAll('input[type=checkbox]').forEach(cb=>{
        cb.addEventListener('change', (e)=>{
          const key = e.target.dataset.key;
          const val = e.target.dataset.val;
          if(!state.selections[key]) state.selections[key]=[];
          const arr = state.selections[key];
          const idx = arr.indexOf(val);
          if(e.target.checked){ if(idx<0) arr.push(val); }
          else{ if(idx>=0) arr.splice(idx,1); }
          saveState(); renderSummaryStrip();
        })
      });
      table.querySelectorAll('.note-toggle').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          const key = e.target.dataset.key;
          const ta = table.querySelector(`textarea[data-key="${cssEscape(key)}"]`);
          ta.classList.toggle('show');
        })
      });
      table.querySelectorAll('textarea.cell-note').forEach(ta=>{
        ta.addEventListener('input', (e)=>{
          const key = e.target.dataset.key;
          state.notes[key] = e.target.value; saveState();
        })
      });

      updateStageBadge();
    }

    function updateStageBadge(){
      const el = document.getElementById('stageBadge');
      if(!el) return;
      el.textContent = `é˜¶æ®µï¼š${state.meta.stage||''}  å­ç‰ˆæœ¬ï¼š${state.meta.subVersion||''}`;
    }

    function renderMeta(){
      const stageSel = document.getElementById('phaseStage');
      stageSel.value = state.meta.stage || 'V1';
      const sv = document.getElementById('subVersion');
      sv.value = state.meta.subVersion || '';
      const status = document.getElementById('metaStatus');
      const confirmBtn = document.getElementById('confirmMeta');
      const editBtn = document.getElementById('editMeta');

      stageSel.disabled = sv.disabled = !!state.meta.confirmed;
      confirmBtn.style.display = state.meta.confirmed ? 'none' : '';
      editBtn.style.display = state.meta.confirmed ? '' : 'none';
      status.textContent = state.meta.confirmed? 'å·²ç¡®è®¤å¹¶æ ‡æ³¨åœ¨è¡¨æ ¼å·¦ä¸Šè§’' : 'æœªç¡®è®¤';
    }

    function renderSummaryStrip(){
      const box = document.getElementById('summaryStrip');
      const items = PHASES.map((phase, idx)=>{
        const lines = CATEGORIES.filter(c=>{
          if(Array.isArray(c.phases)) return c.phases.includes(phase);
          if(c.options_by_phase) return Array.isArray(c.options_by_phase[phase]);
          return false;
        }).map(cat=>{
          const key = keyOf(cat.id, phase);
          const chosen = state.selections[key]||[];
          const short = chosen.slice(0,3).join('ï¼Œ') + (chosen.length>3? ' ç­‰â€¦':'' );
          return chosen.length? `<div class="small"><b>${cat.name}ï¼š</b>${short}</div>`: '';
        }).filter(Boolean).join('');
        return `<div class="card pad summary-card"><div class="small muted">${idx+1}. ${phase}</div>${lines || '<div class="small muted">å°šæœªé€‰æ‹©</div>'}</div>`;
      }).join('');
      box.innerHTML = items;
    }

    function renderTodos(){
      const list = document.getElementById('todoList');
      if(!state.todos) state.todos = [];
      list.innerHTML = '';
      state.todos
        .slice().sort((a,b)=> (a.date||'').localeCompare(b.date||''))
        .forEach((t,idx)=>{
          const div = document.createElement('div');
          div.className = 'todo-item' + (t.done? ' done':'' );
          div.innerHTML = `
            <div>
              <div><b>${escapeHtml(t.text||'')}</b></div>
              <div class="small muted">${t.date || 'æ— æ—¥æœŸ'}</div>
            </div>
            <div style="display:flex;gap:8px">
              <button class="btn ghost small" data-act="toggle" data-idx="${idx}">${t.done? 'æ¢å¤':'å®Œæˆ'}</button>
              <button class="btn warn small" data-act="del" data-idx="${idx}">åˆ é™¤</button>
            </div>`;
          list.appendChild(div);
        });

      list.querySelectorAll('button').forEach(b=>{
        b.addEventListener('click', (e)=>{
          const act = e.target.dataset.act;
          const i = +e.target.dataset.idx;
          if(act==='del'){ state.todos.splice(i,1); }
          if(act==='toggle'){ state.todos[i].done = !state.todos[i].done; }
          saveState(); renderTodos();
        })
      })
    }

    // â€”â€” äº‹ä»¶ â€”â€”
    document.getElementById('confirmMeta').addEventListener('click', ()=>{
      state.meta.stage = document.getElementById('phaseStage').value;
      state.meta.subVersion = document.getElementById('subVersion').value.trim();
      state.meta.confirmed = true; saveState(); renderMeta(); updateStageBadge();
    });
    document.getElementById('editMeta').addEventListener('click', ()=>{
      state.meta.confirmed = false; saveState(); renderMeta();
    });
    document.getElementById('saveBtn').addEventListener('click', ()=>{
      saveState(); alert('å·²ä¿å­˜åˆ°æœ¬åœ°ï¼ˆlocalStorageï¼‰ã€‚');
    });
    document.getElementById('exportBtn').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `tech-matrix-${(state.meta.stage||'V')}-${(state.meta.subVersion||'').replace(/\\s+/g,'')}.json`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });
    document.getElementById('importFile').addEventListener('change', (e)=>{
      const file = e.target.files[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const obj = JSON.parse(reader.result);
          state = Object.assign({}, defaultState, obj);
          saveState(); renderAll();
        }catch(err){ alert('å¯¼å…¥å¤±è´¥ï¼šJSON æ— æ³•è§£æ'); }
      };
      reader.readAsText(file);
    });
    document.getElementById('resetBtn').addEventListener('click', ()=>{
      if(confirm('ç¡®å®šè¦é‡ç½®å—ï¼Ÿè¿™ä¼šæ¸…ç©ºå½“å‰é¡µé¢çš„é€‰æ‹©ä¸è®°å½•ã€‚')){
        state = JSON.parse(JSON.stringify(defaultState));
        saveState(); renderAll();
      }
    });
    document.getElementById('globalNotes').addEventListener('input', (e)=>{
      state.globalNotes = e.target.value; saveState();
    });
    document.getElementById('addTodo').addEventListener('click', ()=>{
      const text = document.getElementById('todoText').value.trim();
      const date = document.getElementById('todoDate').value;
      if(!text) return alert('è¯·è¾“å…¥å¾…åŠå†…å®¹');
      state.todos.push({text,date,done:false});
      document.getElementById('todoText').value='';
      saveState(); renderTodos();
    });

    // æ–°å¢æŠ€æœ¯é€‰é¡¹åŠŸèƒ½
    document.getElementById('addOptionBtn').addEventListener('click', ()=>{
      showAddOptionModal();
    });

    document.getElementById('closeModal').addEventListener('click', ()=>{
      hideAddOptionModal();
    });

    document.getElementById('cancelAdd').addEventListener('click', ()=>{
      hideAddOptionModal();
    });

    document.getElementById('confirmAdd').addEventListener('click', ()=>{
      addNewOption();
    });

    // æ¨¡æ€æ¡†æ˜¾ç¤º/éšè—
    function showAddOptionModal() {
      const modal = document.getElementById('addOptionModal');
      const categorySelect = document.getElementById('categorySelect');
      const phaseSelect = document.getElementById('phaseSelect');
      
      // å¡«å……æŠ€æœ¯ç±»åˆ«é€‰é¡¹
      categorySelect.innerHTML = '<option value="">è¯·é€‰æ‹©æŠ€æœ¯ç±»åˆ«</option>';
      CATEGORIES.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.id;
        option.textContent = cat.name;
        categorySelect.appendChild(option);
      });
      
      // å¡«å……é˜¶æ®µé€‰é¡¹
      phaseSelect.innerHTML = '<option value="">è¯·é€‰æ‹©é˜¶æ®µ</option>';
      PHASES.forEach(phase => {
        const option = document.createElement('option');
        option.value = phase;
        option.textContent = phase;
        phaseSelect.appendChild(option);
      });
      
      modal.style.display = 'flex';
    }

    function hideAddOptionModal() {
      const modal = document.getElementById('addOptionModal');
      modal.style.display = 'none';
      // æ¸…ç©ºè¡¨å•
      document.getElementById('categorySelect').value = '';
      document.getElementById('phaseSelect').value = '';
      document.getElementById('optionContent').value = '';
    }

    function addNewOption() {
      const categoryId = document.getElementById('categorySelect').value;
      const phase = document.getElementById('phaseSelect').value;
      const content = document.getElementById('optionContent').value.trim();
      
      if (!categoryId || !phase || !content) {
        alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
        return;
      }
      
      // æ‰¾åˆ°å¯¹åº”çš„æŠ€æœ¯ç±»åˆ«
      const category = CATEGORIES.find(cat => cat.id === categoryId);
      if (!category) {
        alert('æŠ€æœ¯ç±»åˆ«ä¸å­˜åœ¨');
        return;
      }
      
      // æ·»åŠ æ–°çš„æŠ€æœ¯é€‰é¡¹
      if (category.options_by_phase && category.options_by_phase[phase]) {
        // å¦‚æœè¯¥é˜¶æ®µå·²æœ‰é€‰é¡¹æ•°ç»„ï¼Œç›´æ¥æ·»åŠ 
        category.options_by_phase[phase].push(content);
      } else if (category.options_by_phase) {
        // å¦‚æœè¯¥é˜¶æ®µè¿˜æ²¡æœ‰é€‰é¡¹æ•°ç»„ï¼Œåˆ›å»ºæ–°çš„
        category.options_by_phase[phase] = [content];
      } else if (category.phases && category.phases.includes(phase)) {
        // å¦‚æœä½¿ç”¨phasesæ•°ç»„ä¸”åŒ…å«è¯¥é˜¶æ®µï¼Œæ·»åŠ åˆ°options
        if (!category.options) category.options = [];
        category.options.push(content);
      } else {
        alert('è¯¥æŠ€æœ¯ç±»åˆ«ä¸æ”¯æŒæ­¤é˜¶æ®µ');
        return;
      }
      
      // é‡æ–°æ¸²æŸ“çŸ©é˜µ
      renderMatrix();
      hideAddOptionModal();
      alert('æŠ€æœ¯é€‰é¡¹æ·»åŠ æˆåŠŸï¼');
    }
    // â€”â€” å­˜å– â€”â€”
    const KEY = 'ra-tech-matrix-v3-compact';
    function saveState(){ localStorage.setItem(KEY, JSON.stringify(state)); }
    function loadState(){
      try{ const raw = localStorage.getItem(KEY); return raw? JSON.parse(raw): JSON.parse(JSON.stringify(defaultState)); }
      catch(e){ return JSON.parse(JSON.stringify(defaultState)); }
    }

    // â€”â€” utils â€”â€”
    function keyOf(catId, phase){ return `${catId}|${phase}`; }
    function escapeHtml(s){ return (s||'').replace(/[&<>\"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\'':'&#39;' }[m])); }
    function cssEscape(s){ return (s||'').replace(/[^a-zA-Z0-9_-]/g, m=>`\\${m}`); }

    function renderAll(){
      renderMatrix();
      renderMeta();
      renderSummaryStrip();
      renderTodos();
      document.getElementById('globalNotes').value = state.globalNotes || '';
    }

    // åˆå§‹æ¸²æŸ“
    renderAll();
  </script>
</body>
</html>
