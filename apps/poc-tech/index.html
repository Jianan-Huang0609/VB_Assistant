<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>项目记录 · 技术栈矩阵规划器 · v3 (compact)</title>
  <base href="./">
  <style>
    :root{
      --oat:#EDE3E1; --sage:#C7BEBE; --charcoal:#655C5C; --ink:#2F2A2A; --paper:#FAF8F7;
      --ok:#2e7d32; --warn:#d97706; --muted:#8b8686;
      --radius:22px; --gap:14px; --shadow:0 10px 20px rgba(0,0,0,.06);

      /* 固定配色（不再自动切换） */
      --rowOdd:#FAFAFA;
      --rowEven:#FFFFFF;
      --headOdd:#EDE3E1;
      --headEven:#D6E5E9;
      --hover:#F0F8FF;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--paper);color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue','Noto Sans SC',Arial}
    .wrap{max-width:1400px;margin:24px auto;padding:0 16px}
    .title{font-size:26px;font-weight:800;display:flex;align-items:center;gap:10px}
    .card{background:white;border:1px solid var(--sage);border-radius:var(--radius);box-shadow:var(--shadow)}
    .row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:var(--gap)}
    .card.pad{padding:16px}
    .muted{color:var(--muted)}
    .pill{display:inline-flex;align-items:center;gap:8px;background:var(--oat);border:1px solid var(--sage);padding:6px 10px;border-radius:999px;font-size:12px}
    input[type=text], select, textarea, input[type=date]{width:100%;padding:10px 12px;border:1px solid var(--sage);border-radius:12px;background:#fff}
    textarea{min-height:88px;resize:vertical}

    /* 矩阵表格 */
    .matrix-wrap{margin-top:16px;overflow:auto}
    table.matrix{border-collapse:separate;border-spacing:0;min-width:1600px} /* 更宽 */
    .matrix th,.matrix td{border:1px solid var(--sage);padding:10px;vertical-align:top;background:#fff}
    .matrix thead th{position:sticky;top:0;background:var(--oat);z-index:2}
    .matrix tbody th{position:sticky;left:0;background:var(--oat);z-index:1;min-width:180px} /* 第一列更窄 */
    .matrix td{min-width:240px} /* 数据列更宽 */
    .matrix td.disabled{background:#f5f5f5;color:#aaa;text-align:center}
    .cell-box{display:flex;flex-direction:column;gap:8px}
    .options{display:flex;flex-direction:column;gap:6px}
    .opt{display:flex;align-items:center;gap:8px}
    .opt input[type=checkbox]{width:16px;height:16px;accent-color:var(--charcoal)}
    .note-toggle{cursor:pointer;border:none;background:transparent;color:var(--charcoal);font-size:12px;text-decoration:underline;align-self:flex-start}
    .cell-note{display:none}
    .cell-note.show{display:block}

    /* 行条纹固定 + 悬停 */
    .matrix tbody tr:nth-child(odd) td{background:var(--rowOdd)}
    .matrix tbody tr:nth-child(even) td{background:var(--rowEven)}
    .matrix tbody tr:hover td{background:var(--hover)}
    /* 表头交替色块 */
    .matrix thead th:nth-child(odd){background:var(--headOdd)}
    .matrix thead th:nth-child(even){background:var(--headEven)}

    /* 备注与日历：高度对齐 */
    .row-notes{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap);align-items:stretch}
    .h-260{min-height:260px}

    /* ToDo 样式 + 紧凑工具栏 */
    .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .btn{border:1px solid var(--charcoal);background:var(--charcoal);color:#fff;padding:6px 10px;border-radius:10px;cursor:pointer;font-size:13px}
    .btn.ghost{background:#fff;color:var(--charcoal)}
    .btn.warn{background:var(--warn);border-color:var(--warn)}
    .btn.ok{background:var(--ok);border-color:var(--ok)}
    .small{font-size:12px}
    .todo-item{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border:1px solid var(--sage);border-radius:12px}
    .todo-item.done{opacity:.6;text-decoration:line-through}

    /* 概览条（单行横向滚动的小卡片） */
    .summary-strip{display:flex;gap:10px;overflow:auto;padding:8px}
    .summary-card{min-width:230px;max-width:230px}
    .footer{margin:18px 0 40px;text-align:center;color:var(--muted)}

    /* 模态框样式 */
    .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;display:flex;align-items:center;justify-content:center}
    .modal-content{background:white;border-radius:var(--radius);box-shadow:var(--shadow);max-width:500px;width:90%;max-height:80vh;overflow:hidden}
    .modal-header{display:flex;justify-content:space-between;align-items:center;padding:16px;border-bottom:1px solid var(--sage)}
    .modal-header h3{margin:0;font-size:18px}
    .modal-close{background:none;border:none;font-size:24px;cursor:pointer;color:var(--muted)}
    .modal-body{padding:16px}
    .modal-footer{display:flex;justify-content:flex-end;gap:10px;padding:16px;border-top:1px solid var(--sage)}
    .form-group{margin-bottom:16px}
    .form-group label{display:block;margin-bottom:6px;font-weight:500;color:var(--charcoal)}
    .form-group select,.form-group textarea{width:100%;padding:10px;border:1px solid var(--sage);border-radius:8px;font-size:14px}
    .form-group textarea{resize:vertical;min-height:80px}

    /* 认证状态提示 */
    .auth-status {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 10px 15px;
      border-radius: 8px;
      font-size: 12px;
      z-index: 1000;
    }
    .auth-status.connected { background: rgba(46, 125, 50, 0.8); }
    .auth-status.disconnected { background: rgba(211, 119, 6, 0.8); }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">📒 项目记录 · 技术栈矩阵规划器 <span class="pill muted">纵轴：技术选择｜横轴：阶段</span></div>

    <!-- 认证状态提示 -->
    <div id="authStatus" class="auth-status disconnected">
      🔄 正在检查认证状态...
    </div>

    <!-- 顶部信息栏 -->
    <div class="card pad" style="margin-top:14px">
      <div class="row">
        <div>
          <label class="small muted">开发阶段（V1–V5）</label>
          <select id="phaseStage">
            <option value="V1">V1</option>
            <option value="V2">V2</option>
            <option value="V3">V3</option>
            <option value="V4">V4</option>
            <option value="V5">V5</option>
          </select>
        </div>
        <div>
          <label class="small muted">项目名称</label>
          <input type="text" id="projectName" placeholder="输入项目名称" />
        </div>
        <div>
          <label class="small muted">项目描述</label>
          <input type="text" id="projectDescription" placeholder="简要描述项目目标" />
        </div>
      </div>
    </div>

    <!-- 技术栈矩阵 -->
    <div class="card pad" style="margin-top:14px">
      <div class="toolbar">
        <div class="btn" onclick="saveToSupabase()">💾 保存到云端</div>
        <div class="btn ghost" onclick="loadFromSupabase()">📥 从云端加载</div>
        <div class="btn ghost" onclick="exportData()">📤 导出数据</div>
        <div class="btn ghost" onclick="showAddOptionModal()">➕ 添加技术选项</div>
      </div>
      
      <div class="matrix-wrap">
        <table class="matrix" id="techMatrix">
          <!-- 矩阵内容将通过 JavaScript 动态生成 -->
        </table>
      </div>
    </div>

    <!-- 备注与日历 -->
    <div class="row-notes" style="margin-top:14px">
      <div class="card pad h-260">
        <h4>📝 项目备注</h4>
        <textarea id="globalNotes" placeholder="记录项目相关的备注信息..."></textarea>
      </div>
      <div class="card pad h-260">
        <h4>📅 重要日期</h4>
        <div id="importantDates">
          <div style="margin-bottom:10px;">
            <label class="small muted">开始日期</label>
            <input type="date" id="startDate" />
          </div>
          <div style="margin-bottom:10px;">
            <label class="small muted">预计完成</label>
            <input type="date" id="endDate" />
          </div>
          <div style="margin-bottom:10px;">
            <label class="small muted">里程碑</label>
            <input type="text" id="milestone" placeholder="关键里程碑" />
          </div>
        </div>
      </div>
    </div>

    <!-- 概览条 -->
    <div class="summary-strip" style="margin-top:14px">
      <div class="summary-card card pad">
        <h4>📊 技术覆盖</h4>
        <div id="techCoverage">计算中...</div>
      </div>
      <div class="summary-card card pad">
        <h4>⏱️ 时间规划</h4>
        <div id="timePlanning">计算中...</div>
      </div>
      <div class="summary-card card pad">
        <h4>🎯 完成度</h4>
        <div id="completionRate">计算中...</div>
      </div>
    </div>

    <!-- 添加技术选项模态框 -->
    <div id="addOptionModal" class="modal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h3>添加技术选项</h3>
          <button class="modal-close" onclick="hideAddOptionModal()">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>技术类别</label>
            <select id="categorySelect">
              <option value="">请选择技术类别</option>
            </select>
          </div>
          <div class="form-group">
            <label>开发阶段</label>
            <select id="phaseSelect">
              <option value="">请选择阶段</option>
            </select>
          </div>
          <div class="form-group">
            <label>技术选项内容</label>
            <textarea id="optionContent" placeholder="输入技术选项的具体内容..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn ghost" onclick="hideAddOptionModal()">取消</button>
          <button class="btn" onclick="addNewOption()">添加</button>
        </div>
      </div>
    </div>

    <div class="footer">
      VB Assistant · 技术栈矩阵规划器 v3
    </div>
  </div>

  <!-- Supabase SDK -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  
  <script>
    // 全局变量
    let supabaseClient;
    let currentUser = null;
    let projectId = null;
    
    // 默认状态
    const defaultState = {
      projectName: '',
      projectDescription: '',
      phaseStage: 'V1',
      globalNotes: '',
      startDate: '',
      endDate: '',
      milestone: '',
      matrixData: {},
      lastUpdated: new Date().toISOString()
    };
    
    let state = JSON.parse(JSON.stringify(defaultState));

    // 技术类别定义
    const CATEGORIES = [
      {
        id: 'frontend',
        name: '前端技术',
        phases: ['V1', 'V2', 'V3', 'V4', 'V5'],
        options_by_phase: {
          'V1': ['HTML5', 'CSS3', 'JavaScript'],
          'V2': ['React', 'Vue.js', 'Angular'],
          'V3': ['TypeScript', 'Sass/Less', 'Webpack'],
          'V4': ['PWA', 'SSR', '微前端'],
          'V5': ['WebAssembly', 'WebGL', 'AI集成']
        }
      },
      {
        id: 'backend',
        name: '后端技术',
        phases: ['V1', 'V2', 'V3', 'V4', 'V5'],
        options_by_phase: {
          'V1': ['Node.js', 'Express', 'MongoDB'],
          'V2': ['Python', 'Django', 'PostgreSQL'],
          'V3': ['Java', 'Spring Boot', 'MySQL'],
          'V4': ['微服务', 'Docker', 'Kubernetes'],
          'V5': ['GraphQL', 'gRPC', '事件驱动']
        }
      },
      {
        id: 'devops',
        name: 'DevOps',
        phases: ['V1', 'V2', 'V3', 'V4', 'V5'],
        options_by_phase: {
          'V1': ['Git', 'GitHub', '基础CI/CD'],
          'V2': ['Docker', 'Jenkins', '自动化测试'],
          'V3': ['Kubernetes', '监控', '日志管理'],
          'V4': ['IaC', '云原生', '安全扫描'],
          'V5': ['AI运维', '混沌工程', 'SRE']
        }
      }
    ];

    const PHASES = ['V1', 'V2', 'V3', 'V4', 'V5'];

    // 初始化 Supabase
    async function initSupabase() {
      try {
        supabaseClient = window.supabase.createClient(
          'https://ebbitzscqizogrfyfklh.supabase.co',
          'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImViYml0enNjcWl6b2dyZnlma2xoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0NDAzNTMsImV4cCI6MjA3MjAxNjM1M30.f0gSCCHJ_sEFV9R6IGOcr3CYnaVrZsnIxP3VDFP_RZM'
        );

        // 检查认证状态
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (session) {
          currentUser = session.user;
          updateAuthStatus(true);
          await loadFromSupabase();
        } else {
          updateAuthStatus(false);
          loadFromLocalStorage();
        }

        // 监听认证状态变化
        supabaseClient.auth.onAuthStateChange(async (event, session) => {
          if (event === 'SIGNED_IN') {
            currentUser = session.user;
            updateAuthStatus(true);
            await loadFromSupabase();
          } else if (event === 'SIGNED_OUT') {
            currentUser = null;
            updateAuthStatus(false);
            loadFromLocalStorage();
          }
        });

      } catch (error) {
        console.error('Supabase 初始化失败:', error);
        updateAuthStatus(false);
        loadFromLocalStorage();
      }
    }

    // 更新认证状态显示
    function updateAuthStatus(isConnected) {
      const authStatus = document.getElementById('authStatus');
      if (isConnected) {
        authStatus.textContent = `✅ 已连接 (${currentUser?.email || '用户'})`;
        authStatus.className = 'auth-status connected';
      } else {
        authStatus.textContent = '❌ 未连接 - 数据仅保存到本地';
        authStatus.className = 'auth-status disconnected';
      }
    }

    // 保存到 Supabase
    async function saveToSupabase() {
      if (!currentUser) {
        alert('请先登录以保存到云端');
        return;
      }

      try {
        const projectData = {
          owner: currentUser.id,
          name: state.projectName || '未命名项目',
          description: state.projectDescription,
          phase_stage: state.phaseStage,
          global_notes: state.globalNotes,
          start_date: state.startDate,
          end_date: state.endDate,
          milestone: state.milestone,
          matrix_data: state.matrixData,
          last_updated: new Date().toISOString()
        };

        let result;
        if (projectId) {
          // 更新现有项目
          result = await supabaseClient
            .from('poc_projects')
            .update(projectData)
            .eq('id', projectId)
            .eq('owner', currentUser.id)
            .select()
            .single();
        } else {
          // 创建新项目
          result = await supabaseClient
            .from('poc_projects')
            .insert(projectData)
            .select()
            .single();
          if (result.data) {
            projectId = result.data.id;
          }
        }

        if (result.error) throw result.error;
        
        alert('✅ 数据已保存到云端！');
        console.log('保存成功:', result.data);
      } catch (error) {
        console.error('保存失败:', error);
        alert('❌ 保存失败: ' + error.message);
      }
    }

    // 从 Supabase 加载
    async function loadFromSupabase() {
      if (!currentUser) {
        console.log('用户未登录，无法从云端加载');
        return;
      }

      try {
        // 加载最新的项目数据
        const { data, error } = await supabaseClient
          .from('poc_projects')
          .select('*')
          .eq('owner', currentUser.id)
          .order('last_updated', { ascending: false })
          .limit(1)
          .single();

        if (error && error.code !== 'PGRST116') { // PGRST116 表示没有找到数据
          throw error;
        }

        if (data) {
          projectId = data.id;
          state = {
            projectName: data.name || '',
            projectDescription: data.description || '',
            phaseStage: data.phase_stage || 'V1',
            globalNotes: data.global_notes || '',
            startDate: data.start_date || '',
            endDate: data.end_date || '',
            milestone: data.milestone || '',
            matrixData: data.matrix_data || {},
            lastUpdated: data.last_updated || new Date().toISOString()
          };
          
          updateUI();
          console.log('从云端加载成功:', data);
        } else {
          console.log('云端没有找到项目数据');
        }
      } catch (error) {
        console.error('从云端加载失败:', error);
        alert('❌ 从云端加载失败: ' + error.message);
      }
    }

    // 从本地存储加载（备用）
    function loadFromLocalStorage() {
      try {
        const saved = localStorage.getItem('poc-tech-matrix-v3');
        if (saved) {
          state = JSON.parse(saved);
          updateUI();
          console.log('从本地存储加载成功');
        }
      } catch (error) {
        console.error('从本地存储加载失败:', error);
      }
    }

    // 保存到本地存储（备用）
    function saveToLocalStorage() {
      try {
        localStorage.setItem('poc-tech-matrix-v3', JSON.stringify(state));
      } catch (error) {
        console.error('保存到本地存储失败:', error);
      }
    }

    // 更新 UI
    function updateUI() {
      document.getElementById('projectName').value = state.projectName;
      document.getElementById('projectDescription').value = state.projectDescription;
      document.getElementById('phaseStage').value = state.phaseStage;
      document.getElementById('globalNotes').value = state.globalNotes;
      document.getElementById('startDate').value = state.startDate;
      document.getElementById('endDate').value = state.endDate;
      document.getElementById('milestone').value = state.milestone;
      
      renderMatrix();
      renderSummaryStrip();
    }

    // 渲染技术栈矩阵
    function renderMatrix() {
      const table = document.getElementById('techMatrix');
      
      // 创建表头
      let headerRow = '<thead><tr><th>技术类别</th>';
      PHASES.forEach(phase => {
        headerRow += `<th>${phase}</th>`;
      });
      headerRow += '</tr></thead>';
      
      // 创建表体
      let bodyRows = '<tbody>';
      CATEGORIES.forEach(category => {
        bodyRows += '<tr>';
        bodyRows += `<th>${category.name}</th>`;
        
        PHASES.forEach(phase => {
          const key = keyOf(category.id, phase);
          const cellData = state.matrixData[key] || { selected: [], notes: '' };
          
          bodyRows += '<td>';
          bodyRows += '<div class="cell-box">';
          
          // 技术选项
          if (category.options_by_phase && category.options_by_phase[phase]) {
            category.options_by_phase[phase].forEach(option => {
              const isSelected = cellData.selected.includes(option);
              bodyRows += `
                <div class="opt">
                  <input type="checkbox" 
                         ${isSelected ? 'checked' : ''} 
                         onchange="toggleOption('${category.id}', '${phase}', '${escapeHtml(option)}', this.checked)" />
                  <span>${escapeHtml(option)}</span>
                </div>
              `;
            });
          }
          
          // 备注
          if (cellData.notes) {
            bodyRows += `
              <button class="note-toggle" onclick="toggleNote('${category.id}', '${phase}')">📝 查看备注</button>
              <div class="cell-note" id="note-${category.id}-${phase}">${escapeHtml(cellData.notes)}</div>
            `;
          }
          
          bodyRows += '</div></td>';
        });
        
        bodyRows += '</tr>';
      });
      bodyRows += '</tbody>';
      
      table.innerHTML = headerRow + bodyRows;
    }

    // 渲染概览条
    function renderSummaryStrip() {
      // 计算技术覆盖
      let totalOptions = 0;
      let selectedOptions = 0;
      
      CATEGORIES.forEach(category => {
        PHASES.forEach(phase => {
          if (category.options_by_phase && category.options_by_phase[phase]) {
            totalOptions += category.options_by_phase[phase].length;
            const key = keyOf(category.id, phase);
            const cellData = state.matrixData[key] || { selected: [] };
            selectedOptions += cellData.selected.length;
          }
        });
      });
      
      const coverageRate = totalOptions > 0 ? Math.round((selectedOptions / totalOptions) * 100) : 0;
      
      document.getElementById('techCoverage').innerHTML = `
        <div>已选择: ${selectedOptions}/${totalOptions}</div>
        <div>覆盖率: ${coverageRate}%</div>
      `;
      
      // 时间规划
      const startDate = state.startDate ? new Date(state.startDate) : null;
      const endDate = state.endDate ? new Date(state.endDate) : null;
      
      let timeInfo = '未设置时间';
      if (startDate && endDate) {
        const days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
        timeInfo = `${days} 天`;
      } else if (startDate) {
        timeInfo = '已设置开始时间';
      }
      
      document.getElementById('timePlanning').innerHTML = `
        <div>${timeInfo}</div>
        <div>阶段: ${state.phaseStage}</div>
      `;
      
      // 完成度（基于当前阶段）
      const currentPhaseIndex = PHASES.indexOf(state.phaseStage);
      const completionRate = currentPhaseIndex >= 0 ? Math.round(((currentPhaseIndex + 1) / PHASES.length) * 100) : 0;
      
      document.getElementById('completionRate').innerHTML = `
        <div>当前阶段: ${state.phaseStage}</div>
        <div>完成度: ${completionRate}%</div>
      `;
    }

    // 切换技术选项
    function toggleOption(categoryId, phase, option, isSelected) {
      const key = keyOf(categoryId, phase);
      if (!state.matrixData[key]) {
        state.matrixData[key] = { selected: [], notes: '' };
      }
      
      if (isSelected) {
        if (!state.matrixData[key].selected.includes(option)) {
          state.matrixData[key].selected.push(option);
        }
      } else {
        state.matrixData[key].selected = state.matrixData[key].selected.filter(item => item !== option);
      }
      
      state.lastUpdated = new Date().toISOString();
      saveToLocalStorage(); // 本地备份
      
      if (currentUser) {
        saveToSupabase(); // 自动保存到云端
      }
    }

    // 切换备注显示
    function toggleNote(categoryId, phase) {
      const noteElement = document.getElementById(`note-${categoryId}-${phase}`);
      noteElement.classList.toggle('show');
    }

    // 导出数据
    function exportData() {
      const dataStr = JSON.stringify(state, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `poc-tech-matrix-${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      URL.revokeObjectURL(url);
    }

    // 添加技术选项相关函数
    function showAddOptionModal() {
      const modal = document.getElementById('addOptionModal');
      const categorySelect = document.getElementById('categorySelect');
      const phaseSelect = document.getElementById('phaseSelect');
      
      // 填充技术类别选项
      categorySelect.innerHTML = '<option value="">请选择技术类别</option>';
      CATEGORIES.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.id;
        option.textContent = cat.name;
        categorySelect.appendChild(option);
      });
      
      // 填充阶段选项
      phaseSelect.innerHTML = '<option value="">请选择阶段</option>';
      PHASES.forEach(phase => {
        const option = document.createElement('option');
        option.value = phase;
        option.textContent = phase;
        phaseSelect.appendChild(option);
      });
      
      modal.style.display = 'flex';
    }

    function hideAddOptionModal() {
      const modal = document.getElementById('addOptionModal');
      modal.style.display = 'none';
      // 清空表单
      document.getElementById('categorySelect').value = '';
      document.getElementById('phaseSelect').value = '';
      document.getElementById('optionContent').value = '';
    }

    function addNewOption() {
      const categoryId = document.getElementById('categorySelect').value;
      const phase = document.getElementById('phaseSelect').value;
      const content = document.getElementById('optionContent').value.trim();
      
      if (!categoryId || !phase || !content) {
        alert('请填写完整信息');
        return;
      }
      
      // 找到对应的技术类别
      const category = CATEGORIES.find(cat => cat.id === categoryId);
      if (!category) {
        alert('技术类别不存在');
        return;
      }
      
      // 添加新的技术选项
      if (category.options_by_phase && category.options_by_phase[phase]) {
        category.options_by_phase[phase].push(content);
      } else if (category.options_by_phase) {
        category.options_by_phase[phase] = [content];
      } else {
        alert('该技术类别不支持此阶段');
        return;
      }
      
      // 重新渲染矩阵
      renderMatrix();
      hideAddOptionModal();
      alert('技术选项添加成功！');
    }

    // 工具函数
    function keyOf(catId, phase) { return `${catId}|${phase}`; }
    function escapeHtml(s) { return (s||'').replace(/[&<>\"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\'':'&#39;' }[m])); }

    // 监听输入变化
    document.getElementById('projectName').addEventListener('input', function() {
      state.projectName = this.value;
      state.lastUpdated = new Date().toISOString();
      saveToLocalStorage();
      if (currentUser) saveToSupabase();
    });

    document.getElementById('projectDescription').addEventListener('input', function() {
      state.projectDescription = this.value;
      state.lastUpdated = new Date().toISOString();
      saveToLocalStorage();
      if (currentUser) saveToSupabase();
    });

    document.getElementById('phaseStage').addEventListener('change', function() {
      state.phaseStage = this.value;
      state.lastUpdated = new Date().toISOString();
      saveToLocalStorage();
      if (currentUser) saveToSupabase();
      renderSummaryStrip();
    });

    document.getElementById('globalNotes').addEventListener('input', function() {
      state.globalNotes = this.value;
      state.lastUpdated = new Date().toISOString();
      saveToLocalStorage();
      if (currentUser) saveToSupabase();
    });

    document.getElementById('startDate').addEventListener('change', function() {
      state.startDate = this.value;
      state.lastUpdated = new Date().toISOString();
      saveToLocalStorage();
      if (currentUser) saveToSupabase();
      renderSummaryStrip();
    });

    document.getElementById('endDate').addEventListener('change', function() {
      state.endDate = this.value;
      state.lastUpdated = new Date().toISOString();
      saveToLocalStorage();
      if (currentUser) saveToSupabase();
      renderSummaryStrip();
    });

    document.getElementById('milestone').addEventListener('input', function() {
      state.milestone = this.value;
      state.lastUpdated = new Date().toISOString();
      saveToLocalStorage();
      if (currentUser) saveToSupabase();
    });

    // 初始化
    initSupabase();
  </script>
</body>
</html>
